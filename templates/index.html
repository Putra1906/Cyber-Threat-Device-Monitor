<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cyber Threat Device Monitor</title>

  <!-- Tailwind (kalau sudah build local, pakai file kamu sendiri) -->
  <link href="/static/style.css" rel="stylesheet">

  <!-- Leaflet CDN -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIJt6NK3tFZfHbQ5rWgo2NK3G0C6XQ0="
    crossorigin=""
  ></script>

  <style>
    /* Badge style mirip screenshot */
    .badge { @apply inline-flex items-center px-3 py-1 rounded-full text-sm font-medium; }
    .badge-allowed { @apply bg-green-100 text-green-700; }
    .badge-blocked { @apply bg-red-100 text-red-700; }
    .badge-maintenance { @apply bg-orange-100 text-orange-700; }

    /* Table vibe */
    .table { @apply w-full text-left border-separate border-spacing-0; }
    .thead th { @apply bg-white font-semibold text-gray-700 border-b; }
    .tbody tr { @apply bg-white; }
    .tbody tr + tr td { @apply border-t; }
    .cell { @apply p-4 align-top; }

    /* Integration link */
    .link { @apply text-blue-600 hover:underline; }

    /* Card + Map */
    .card { @apply bg-white rounded-xl shadow-sm; }
    #map { height: 520px; border-radius: 0.75rem; }
    .map-legend {
      position: absolute; right: 16px; top: 16px;
      background: white; border-radius: 0.75rem; padding: 12px 14px;
      box-shadow: 0 1px 3px rgba(0,0,0,.1);
      max-width: 220px; font-size: 14px;
    }
    .legend-dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; vertical-align:middle; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <main class="max-w-7xl mx-auto p-6 space-y-8">
    <!-- TABEL PERANGKAT -->
    <section class="card">
      <div class="p-6 border-b">
        <h2 class="text-xl font-semibold">Devices</h2>
      </div>
      <div class="overflow-x-auto">
        <table class="table">
          <thead class="thead">
            <tr>
              <th class="cell">Device</th>
              <th class="cell">IP Address</th>
              <th class="cell">Location</th>
              <th class="cell">Status</th>
              <th class="cell">Internet Area</th>
              <th class="cell">Integration</th>
              <th class="cell">Last Updated</th>
              <th class="cell">Actions</th>
            </tr>
          </thead>
          <tbody class="tbody">
            {% for d in devices %}
            <tr>
              <!-- Device name + type kecil -->
              <td class="cell">
                <div class="font-medium">{{ d.name }}</div>
                <div class="text-gray-500 text-sm">{{ d.type }}</div>
              </td>

              <td class="cell font-mono">{{ d.ip }}</td>
              <td class="cell">{{ d.location }}</td>

              <!-- Badge status -->
              <td class="cell">
                {% set s = (d.status or '').lower() %}
                {% if s == 'allowed' %}
                  <span class="badge badge-allowed">Allowed</span>
                {% elif s == 'blocked' %}
                  <span class="badge badge-blocked">Blocked</span>
                {% else %}
                  <span class="badge badge-maintenance">Maintenance</span>
                {% endif %}
              </td>

              <!-- Internet Area + VLAN -->
              <td class="cell">
                <div class="font-medium">{{ d.internet_area }}</div>
                <div class="text-gray-500 text-sm">VLAN {{ d.vlan or '-' }}</div>
              </td>

              <!-- Integration (contoh: 8 connected) -->
              <td class="cell">
                {% if d.integration_count %}
                  <a href="#" class="link">{{ d.integration_count }} connected</a>
                {% else %}
                  <span class="text-gray-500">—</span>
                {% endif %}
              </td>

              <td class="cell">
                {{ d.last_updated or '-' }}
              </td>

              <td class="cell">
                <button class="px-2 py-1 rounded hover:bg-gray-100">⋯</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- MAP -->
    <section class="card relative">
      <div class="p-6 border-b">
        <h2 class="text-xl font-semibold">Device Locations</h2>
        <p class="text-gray-500 text-sm">Interactive map showing device locations and status</p>
      </div>
      <div class="p-6">
        <div id="map"></div>

        <!-- Legend -->
        <div class="map-legend">
          <div class="font-semibold mb-2">Map Legend</div>
          <div class="mb-2">
            <div><span class="legend-dot" style="background:#16a34a;"></span>Device Status — Allowed</div>
            <div><span class="legend-dot" style="background:#dc2626;"></span>Device Status — Blocked</div>
            <div><span class="legend-dot" style="background:#ea580c;"></span>Device Status — Maintenance</div>
          </div>
          <div class="text-xs text-gray-500 mt-2">Leaflet | © OpenStreetMap contributors</div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Pusat peta — fallback Bandung
    const center = {{ map_center|default([ -6.939, 107.635 ])|tojson }};
    const devices = {{ devices|tojson }};

    const map = L.map('map').setView(center, 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // warna marker sesuai status
    function statusColor(s){
      s = (s||'').toLowerCase();
      if (s === 'allowed') return '#16a34a';
      if (s === 'blocked') return '#dc2626';
      return '#ea580c'; // maintenance
    }

    // Simple circle markers
    let plotted = 0;
    devices.forEach(d => {
      if (d.lat != null && d.lng != null) {
        const marker = L.circleMarker([d.lat, d.lng], {
          radius: 8,
          fillColor: statusColor(d.status),
          fillOpacity: 0.9,
          color: '#fff',
          weight: 2
        }).addTo(map);

        marker.bindPopup(`
          <div style="font-weight:600">${d.name}</div>
          <div style="color:#6b7280; font-size:12px">${d.type||''}</div>
          <div style="margin-top:6px"><span style="font-family:ui-monospace">${d.ip||'-'}</span></div>
          <div style="color:#6b7280; font-size:12px">${d.location||''}</div>
          <div style="margin-top:6px">Status: <b>${d.status||'-'}</b></div>
          <div style="color:#6b7280; font-size:12px">${d.internet_area||''} · VLAN ${d.vlan||'-'}</div>
        `);
        plotted++;
      }
    });

    // Badge “10 devices mapped” ala screenshot
    const badge = L.control({position:'bottomleft'});
    badge.onAdd = function(){
      const div = L.DomUtil.create('div');
      div.style.background='white';
      div.style.padding='8px 10px';
      div.style.borderRadius='12px';
      div.style.boxShadow='0 1px 3px rgba(0,0,0,.1)';
      div.style.fontWeight='600';
      div.textContent = `${plotted} devices mapped`;
      return div;
    };
    badge.addTo(map);
  </script>
</body>
</html>
